# Bundle Badger

A GitLab-native bundle size tracking tool. Runs in GitLab CI, compares bundle sizes between MR and baseline, and posts a report as an MR comment.

## Requirements

- Node.js >= 18
- npm

## Installation

```bash
npm install bundle-badger
```

Or install globally:

```bash
npm install -g bundle-badger
```

## Quick Start

```bash
# Basic usage - analyze a stats file
bundle-badger --stats ./dist/stats.json

# Compare against a baseline
bundle-badger --stats ./dist/stats.json --baseline ./baseline/stats.json

# Set a threshold (exit code 1 if exceeded)
bundle-badger --stats ./dist/stats.json --threshold 5%

# Dry run (no GitLab comment)
bundle-badger --stats ./dist/stats.json --dry-run

# JSON output
bundle-badger --stats ./dist/stats.json --format json
```

## GitLab CI Integration

Add to your `.gitlab-ci.yml`:

```yaml
bundle-report:
  stage: test
  image: node:20
  script:
    - npm ci
    - npm run build
    - npx bundle-badger --stats ./dist/stats.json
  rules:
    - if: $CI_MERGE_REQUEST_IID
```

### Environment Variables

When running in GitLab CI, these are auto-detected:

| Variable | Description | Required |
|----------|-------------|----------|
| `GITLAB_TOKEN` | Personal access token with `api` scope | Yes |
| `CI_API_V4_URL` | GitLab API URL | Auto-detected |
| `CI_PROJECT_ID` | Project ID | Auto-detected |
| `CI_MERGE_REQUEST_IID` | MR number | Auto-detected |
| `CI_COMMIT_REF_NAME` | Branch name | Auto-detected |

## Supported Bundlers

- **Webpack** - Reads `stats.json` generated by webpack
- **Vite** - Reads build output manifest

### Webpack Setup

Enable stats output in your webpack config:

```javascript
// webpack.config.js
const { BundleAnalyzerPlugin } = require('webpack-bundle-analyzer');

module.exports = {
  plugins: [
    new BundleAnalyzerPlugin({
      analyzerMode: 'disabled',
      generateStatsFile: true,
      statsFilename: 'stats.json',
    }),
  ],
};
```

### Vite Setup

Vite generates a manifest by default in build mode:

```javascript
// vite.config.js
export default {
  build: {
    manifest: true,
  },
};
```

## Report Format

Bundle Badger posts a markdown report to your MR:

```markdown
## Bundle Badger Report

| File      | Before   | After    | Diff               |
|-----------|----------|----------|--------------------|
| main.js   | 142.3 kB | 148.7 kB | +6.4 kB (+4.5%)    |
| vendor.js | 89.2 kB  | 89.2 kB  | 0                  |

**Total:** 243.6 kB -> 249.7 kB (+6.1 kB / +2.5%)
```

---

## Development

### Setup

```bash
# Clone the repository
git clone https://gitlab.com/mbuga/bundle-badger.git
cd bundle-badger

# Install dependencies
npm install
```

### Commands

```bash
# Build the project
npm run build

# Watch mode (rebuild on changes)
npm run dev

# Run CLI in development
npm run dev -- --stats ./test/fixtures/stats.json

# Type check
npm run typecheck

# Lint
npm run lint

# Run tests
npm test
```

### Project Structure

```
bundle-badger/
├── src/
│   ├── index.ts          # CLI entry point (commander)
│   ├── parsers/
│   │   ├── index.ts      # Parser exports
│   │   ├── types.ts      # Type definitions
│   │   ├── webpack.ts    # Webpack stats parser
│   │   └── vite.ts       # Vite manifest parser
│   ├── compare.ts        # Diff calculation logic
│   ├── report.ts         # Markdown report generation
│   ├── gitlab.ts         # GitLab API client
│   └── utils.ts          # Utility functions
├── test/
│   └── fixtures/         # Sample stats.json files
├── dist/                 # Built output
├── package.json
├── tsconfig.json
├── rollup.config.js
└── CLAUDE.md
```

### Build

The project uses Rollup to bundle the CLI:

```bash
npm run build
```

This outputs `dist/index.js` with a shebang for CLI execution.

### Testing

Tests use Vitest:

```bash
# Run all tests
npm test

# Run tests in watch mode
npm test -- --watch

# Run tests with coverage
npm test -- --coverage
```

### Linting

```bash
# Run ESLint
npm run lint

# Fix auto-fixable issues
npm run lint -- --fix
```

### Type Checking

```bash
npm run typecheck
```

---

## License

MIT
